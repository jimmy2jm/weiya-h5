<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>2026å¹´ä¼šé‚€è¯·å‡½</title>
    <style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:-apple-system,BlinkMacSystemFont,'PingFang SC',sans-serif}
#app{position:relative;width:100%;height:100%;margin:0 auto;overflow:hidden;background:#000}
@media(min-aspect-ratio:9/16){#app{width:calc(100vh*9/16);height:100vh;margin:0 auto}}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.screen.hidden{display:none}
#loading-screen{background:linear-gradient(135deg,#1a1a2e,#16213e,#0f0f23);z-index:100}
.loading-content{text-align:center;color:#fff}
.loading-spinner{width:50px;height:50px;border:3px solid rgba(255,255,255,0.1);border-top-color:#ffd700;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:16px;opacity:0.8;margin-bottom:10px}
.loading-progress{font-size:24px;font-weight:bold;color:#ffd700}
#start-screen{background:transparent;z-index:50}
.start-bg-video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}
.start-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);z-index:2}
.start-content{position:absolute;top:25%;left:50%;transform:translate(-50%,-50%);z-index:3;text-align:center;padding:20px;width:100%}
.start-title{
    font-size: 42px;
    font-weight: 900;
    background: linear-gradient(90deg, #8B4513, #D2691E, #CD853F, #DEB887, #F4A460, #D2691E, #8B4513);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: title-flow 3s linear infinite;
    letter-spacing: 4px;
    filter: drop-shadow(0 0 15px rgba(210,105,30,0.5));
    margin-bottom: 15px;
}
.start-subtitle{
    font-size: 28px;
    font-weight: 900;
    background: linear-gradient(90deg, #8B4513, #D2691E, #CD853F, #DEB887, #F4A460, #D2691E, #8B4513);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: title-flow 3s linear infinite;
    letter-spacing: 8px;
    filter: drop-shadow(0 0 10px rgba(210,105,30,0.4));
    margin-bottom: 0;
}
@keyframes title-flow{to{background-position:200% center}}
.start-btn-container{position:absolute;bottom:25%;left:50%;transform:translateX(-50%);z-index:3}
.glow-btn{
    padding: 15px 50px;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
    background: linear-gradient(135deg, #8B4513, #D2691E);
    border: none;
    border-radius: 50px;
    cursor: pointer;
    animation: breathe 2s ease-in-out infinite;
}
@keyframes breathe {
    0%, 100% { 
        box-shadow: 0 0 20px rgba(210,105,30,0.4);
        transform: scale(1);
    }
    50% { 
        box-shadow: 0 0 40px rgba(210,105,30,0.8), 0 0 60px rgba(210,105,30,0.4);
        transform: scale(1.02);
    }
}
#video-container{background:#000;z-index:10}
.fullscreen-video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity 0.1s}
.fullscreen-video.active{opacity:1}
.btn-container{position:absolute;bottom:15%;left:50%;transform:translateX(-50%);z-index:20}
.btn-container.hidden{display:none}
#end-screen{background:#000;z-index:30}
.end-bg-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}
.end-surprise{position:absolute;top:40%;left:55%;transform:translate(-50%,-50%);z-index:2;text-align:center;width:100%}
.surprise-text{font-size:38px;font-weight:900;background:linear-gradient(90deg,#8B4513,#D2691E,#CD853F,#DEB887,#F4A460,#D2691E,#8B4513);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:title-flow 3s linear infinite;letter-spacing:6px;filter:drop-shadow(0 0 15px rgba(210,105,30,0.5));margin-bottom:12px;white-space:nowrap}
.end-content{position:absolute;bottom:-2%;left:50%;transform:translateX(-50%);z-index:2;text-align:center;padding:15px;width:100%}
.end-info{margin-bottom:15px}
.info-item{display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:600;color:#5D4037;margin-bottom:10px;text-shadow:1px 1px 2px rgba(255,255,255,0.8),-1px -1px 2px rgba(255,255,255,0.5)}
.info-item:last-child{margin-bottom:0}
.info-icon{font-size:20px;margin-right:8px}
.outline-btn{padding:10px 25px;font-size:13px;font-weight:500;color:#5D4037;background:rgba(255,255,255,0.6);border:1px solid rgba(139,69,19,0.3);border-radius:20px;cursor:pointer;text-shadow:none}
.outline-btn:hover{background:rgba(255,255,255,0.8)}
    </style>
</head>
<body>
<div id="app">
    <div id="loading-screen" class="screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">æ­£åœ¨åŠ è½½ç²¾å½©å†…å®¹...</p>
            <p class="loading-progress">0%</p>
        </div>
    </div>
    <div id="start-screen" class="screen hidden">
        <video id="start-video" class="start-bg-video" playsinline webkit-playsinline muted preload="auto"></video>
        <div class="start-overlay"></div>
        <div class="start-content">
            <h1 class="start-title">2026<br>ä¸‰ç¤¾ç»¼å°¾ç‰™å®´</h1>
        </div>
        <div class="start-btn-container">
            <button id="start-btn" class="glow-btn">ç‚¹å‡»å¼€å§‹</button>
        </div>
    </div>
    <div id="video-container" class="screen hidden">
        <video id="video1" class="fullscreen-video active" playsinline webkit-playsinline x5-video-player-type="h5" preload="auto"></video>
        <video id="video2" class="fullscreen-video" playsinline webkit-playsinline x5-video-player-type="h5" preload="auto"></video>
        <div id="continue-btn-container" class="btn-container hidden">
            <button id="continue-btn" class="glow-btn pulse">ç»§ç»­æ¢ç´¢</button>
        </div>
    </div>
    <div id="end-screen" class="screen hidden">
        <img id="end-bg" class="end-bg-image" src="" alt="èƒŒæ™¯">
        <div class="end-surprise">
            <p class="surprise-text">è¿˜æœ‰å½©è›‹ï¼Ÿ</p>
            <p class="surprise-text">æ™šä¼šæ­æ™“ï¼</p>
        </div>
        <div class="end-content">
            <div class="end-info">
                <p class="info-item"><span class="info-icon">ğŸ“…</span><span>2026å¹´2æœˆ9æ—¥ 18:00</span></p>
                <p class="info-item"><span class="info-icon">ğŸ“</span><span>ä¸œæµ·æ¸”åº„</span></p>
                <p class="info-item"><span class="info-icon">ğŸ‘”</span><span>ç¾æ‹‰å¾·</span></p>
            </div>
            <button id="replay-btn" class="outline-btn">å†çœ‹ä¸€æ¬¡</button>
        </div>
    </div>
</div>
<script>
/**
 * 2026å¹´ä¼šé‚€è¯·å‡½ - è§†é¢‘æ’­æ”¾æ§åˆ¶
 * æ ¸å¿ƒç­–ç•¥ï¼štimeupdate + ended åŒé‡æ£€æµ‹ï¼ŒçŠ¶æ€æœºç®¡ç†
 */

// ============ é…ç½® ============
const CONFIG = {
    video1Url: 'https://weiya-h5-1400603784.cos.ap-guangzhou.myqcloud.com/assets/video1.mp4',
    video2Url: 'https://weiya-h5-1400603784.cos.ap-guangzhou.myqcloud.com/assets/video2.mp4',
    endBgUrl: 'https://weiya-h5-1400603784.cos.ap-guangzhou.myqcloud.com/assets/end-bg.png',  // ç»“æŸé¡µèƒŒæ™¯å›¾
    endDelayMs: 2000,  // è§†é¢‘2ç»“æŸåå»¶è¿Ÿåˆ‡æ¢æ—¶é—´
};

// ============ çŠ¶æ€æœº ============
const State = {
    LOADING: 'loading',
    START: 'start',
    PLAYING_V1: 'playing_v1',
    WAITING: 'waiting',
    PLAYING_V2: 'playing_v2',
    END: 'end'
};

let currentState = State.LOADING;
let cleanupFn = null;  // å½“å‰è§†é¢‘çš„äº‹ä»¶æ¸…ç†å‡½æ•°

// ============ DOM å…ƒç´  ============
const $ = id => document.getElementById(id);
const elements = {
    loadingScreen: $('loading-screen'),
    startScreen: $('start-screen'),
    videoContainer: $('video-container'),
    endScreen: $('end-screen'),
    startVideo: $('start-video'),
    video1: $('video1'),
    video2: $('video2'),
    endBg: $('end-bg'),
    continueBtn: $('continue-btn-container'),
    progress: document.querySelector('.loading-progress'),
};

// ============ å·¥å…·å‡½æ•° ============
function showScreen(screen) {
    document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
    screen.classList.remove('hidden');
}

function updateProgress(percent) {
    elements.progress.textContent = Math.round(percent) + '%';
}

function log(msg) {
    console.log(`[${currentState}] ${msg}`);
}

// ============ è§†é¢‘æ’­æ”¾å®Œæˆæ£€æµ‹å™¨ï¼ˆæ ¸å¿ƒï¼‰ ============
function createVideoEndDetector(video, onComplete) {
    let completed = false;
    let lastTime = -1;
    let stuckCount = 0;
    
    const tryComplete = (source) => {
        if (completed) return;
        completed = true;
        log(`è§†é¢‘æ’­æ”¾å®Œæˆ (æ¥æº: ${source})`);
        video.pause();
        // æ¸…ç†äº‹ä»¶
        cleanup();
        onComplete();
    };
    
    // ä¸»æ£€æµ‹ï¼štimeupdate - æ£€æŸ¥æ˜¯å¦æ¥è¿‘ç»“å°¾
    const onTimeUpdate = () => {
        if (completed) return;
        const duration = video.duration;
        const current = video.currentTime;
        
        // é˜²æ­¢ duration ä¸º NaN æˆ– 0
        if (!duration || duration <= 0) return;
        
        // å½“æ’­æ”¾ä½ç½®æ¥è¿‘ç»“å°¾æ—¶ï¼ˆå‰©ä½™ä¸åˆ°0.5ç§’ï¼‰
        if (current >= duration - 0.5) {
            tryComplete('timeupdate');
            return;
        }
        
        // æ£€æµ‹æ˜¯å¦å¡ä½ï¼ˆæ’­æ”¾ä½ç½®é•¿æ—¶é—´ä¸å˜ï¼‰
        if (current === lastTime) {
            stuckCount++;
            if (stuckCount > 10 && current >= duration - 1) {
                tryComplete('stuck');
            }
        } else {
            stuckCount = 0;
            lastTime = current;
        }
    };
    
    // å¤‡ç”¨æ£€æµ‹ï¼šended äº‹ä»¶
    const onEnded = () => {
        tryComplete('ended');
    };
    
    // é¢å¤–ä¿é™©ï¼šæ’­æ”¾æš‚åœä¸”æ¥è¿‘ç»“å°¾
    const onPause = () => {
        if (completed) return;
        const duration = video.duration;
        const current = video.currentTime;
        if (duration > 0 && current >= duration - 0.5) {
            tryComplete('pause');
        }
    };
    
    // ç»‘å®šäº‹ä»¶
    video.addEventListener('timeupdate', onTimeUpdate);
    video.addEventListener('ended', onEnded);
    video.addEventListener('pause', onPause);
    
    // æ¸…ç†å‡½æ•°
    const cleanup = () => {
        video.removeEventListener('timeupdate', onTimeUpdate);
        video.removeEventListener('ended', onEnded);
        video.removeEventListener('pause', onPause);
    };
    
    return cleanup;
}

// ============ çŠ¶æ€åˆ‡æ¢ ============
function setState(newState) {
    log(`çŠ¶æ€åˆ‡æ¢: ${currentState} -> ${newState}`);
    
    // æ¸…ç†ä¸Šä¸€ä¸ªçŠ¶æ€çš„äº‹ä»¶ç›‘å¬
    if (cleanupFn) {
        cleanupFn();
        cleanupFn = null;
    }
    
    currentState = newState;
    
    switch (newState) {
        case State.START:
            showScreen(elements.startScreen);
            break;
            
        case State.PLAYING_V1:
            showScreen(elements.videoContainer);
            elements.continueBtn.classList.add('hidden');
            elements.video1.classList.add('active');
            elements.video1.currentTime = 0;
            elements.video1.play().then(() => {
                log('è§†é¢‘1å¼€å§‹æ’­æ”¾');
            }).catch(e => {
                log('è§†é¢‘1æ’­æ”¾å¤±è´¥: ' + e.message);
            });
            // è®¾ç½®å®Œæˆæ£€æµ‹
            cleanupFn = createVideoEndDetector(elements.video1, () => {
                setState(State.WAITING);
            });
            break;
            
        case State.WAITING:
            elements.video1.pause();
            elements.continueBtn.classList.remove('hidden');
            log('ç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç»§ç»­');
            break;
            
        case State.PLAYING_V2:
            elements.continueBtn.classList.add('hidden');
            elements.video2.currentTime = 0;
            elements.video2.classList.add('active');
            elements.video2.play().then(() => {
                log('è§†é¢‘2å¼€å§‹æ’­æ”¾');
                // æ’­æ”¾æˆåŠŸåå†éšè—è§†é¢‘1
                setTimeout(() => {
                    elements.video1.classList.remove('active');
                }, 100);
            }).catch(e => {
                log('è§†é¢‘2æ’­æ”¾å¤±è´¥: ' + e.message);
            });
            // è®¾ç½®å®Œæˆæ£€æµ‹
            cleanupFn = createVideoEndDetector(elements.video2, () => {
                log(`è§†é¢‘2æ’­æ”¾å®Œæˆï¼Œ${CONFIG.endDelayMs}ms ååˆ‡æ¢åˆ°ç»“æŸé¡µé¢`);
                setTimeout(() => {
                    setState(State.END);
                }, CONFIG.endDelayMs);
            });
            break;
            
        case State.END:
            elements.video2.pause();
            showScreen(elements.endScreen);
            break;
    }
}

// ============ é¢„åŠ è½½ ============
function preload() {
    return new Promise((resolve) => {
        let video1Ready = false;
        let progress1 = 0;
        
        // è®¾ç½®è§†é¢‘æº
        elements.startVideo.src = CONFIG.video1Url;
        elements.video1.src = CONFIG.video1Url;
        elements.video2.src = CONFIG.video2Url;
        
        // è®¾ç½®ç»“æŸé¡µèƒŒæ™¯å›¾
        elements.endBg.src = CONFIG.endBgUrl;
        
        // å¼€å§‹é¡µé¢è§†é¢‘ï¼šåŠ è½½åæš‚åœåœ¨é¦–å¸§
        elements.startVideo.addEventListener('loadeddata', () => {
            elements.startVideo.currentTime = 0;
            elements.startVideo.pause();
            log('å¼€å§‹é¡µé¢èƒŒæ™¯è§†é¢‘å·²åŠ è½½');
        }, { once: true });
        
        // é€šç”¨è¿›åº¦æ›´æ–°å‡½æ•°
        const updateVideoProgress = () => {
            const video = elements.video1;
            if (video.buffered.length > 0 && isFinite(video.duration) && video.duration > 0) {
                const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                progress1 = (bufferedEnd / video.duration) * 100;
                updateProgress(Math.min(progress1, 99)); // æœ€å¤š99%ï¼Œ100%ç”±canplaythroughè§¦å‘
            }
        };
        
        // å¤šäº‹ä»¶æºæ›´æ–°è¿›åº¦
        elements.video1.addEventListener('loadedmetadata', () => {
            log(`è§†é¢‘1å…ƒæ•°æ®å·²åŠ è½½ï¼Œæ—¶é•¿: ${elements.video1.duration}ç§’`);
            updateVideoProgress();
        });
        elements.video1.addEventListener('progress', updateVideoProgress);
        elements.video1.addEventListener('loadeddata', () => {
            updateVideoProgress();
            if (progress1 < 30) updateProgress(30); // ä¿åº•30%
        });
        elements.video1.addEventListener('canplay', () => {
            updateVideoProgress();
            if (progress1 < 80) updateProgress(80); // ä¿åº•80%
        });
        
        // è§†é¢‘1å¯æ’­æ”¾
        elements.video1.addEventListener('canplaythrough', () => {
            if (!video1Ready) {
                video1Ready = true;
                updateProgress(100);
                log('è§†é¢‘1åŠ è½½å®Œæˆ');
                setTimeout(resolve, 300);
            }
        }, { once: true });
        
        // å¼€å§‹åŠ è½½
        elements.startVideo.load();
        elements.video1.load();
        elements.video2.load();
        
        // è¶…æ—¶å¤„ç†
        setTimeout(() => {
            if (!video1Ready && elements.video1.readyState >= 3) {
                video1Ready = true;
                resolve();
            }
        }, 30000);
    });
}

// ============ äº‹ä»¶ç»‘å®š ============
function bindEvents() {
    // å¼€å§‹æŒ‰é’®
    $('start-btn').onclick = () => {
        if (currentState === State.START) {
            setState(State.PLAYING_V1);
        }
    };
    
    // ç»§ç»­æŒ‰é’®
    $('continue-btn').onclick = () => {
        if (currentState === State.WAITING) {
            setState(State.PLAYING_V2);
        }
    };
    
    // é‡æ’­æŒ‰é’®
    $('replay-btn').onclick = () => {
        if (currentState === State.END) {
            // é‡ç½®è§†é¢‘çŠ¶æ€
            elements.video1.currentTime = 0;
            elements.video2.currentTime = 0;
            elements.video1.classList.add('active');
            elements.video2.classList.remove('active');
            setState(State.PLAYING_V1);
        }
    };
}

// ============ åˆå§‹åŒ– ============
async function init() {
    log('åˆå§‹åŒ–å¼€å§‹');
    bindEvents();
    await preload();
    setState(State.START);
    log('åˆå§‹åŒ–å®Œæˆ');
}

// å¯åŠ¨
init();
</script>
</body>
</html>
